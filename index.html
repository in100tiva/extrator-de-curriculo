<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Extrator de Curr√≠culos em Lote</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@4.4.168/build/pdf.min.mjs" type="module"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .progress-bar { transition: width 0.3s ease-in-out; }
        .batch-status { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-4">

    <div class="max-w-6xl mx-auto bg-white rounded-2xl shadow-lg p-8">
        <header class="text-center mb-8">
            <h1 class="text-3xl font-bold text-gray-800">Extrator de Curr√≠culos em Lote</h1>
            <p class="text-gray-600 mt-2">Processe at√© 200 curr√≠culos PDFs de uma vez - Otimizado para Vercel</p>
        </header>

        <!-- Upload Section -->
        <div class="text-center mb-6">
            <label for="pdfFiles" class="cursor-pointer inline-flex items-center px-6 py-3 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 transition">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                </svg>
                Selecionar Curr√≠culos PDF
            </label>
            <input type="file" id="pdfFiles" accept=".pdf" class="hidden" multiple>
            <p id="fileCount" class="text-sm text-gray-600 mt-2"></p>
        </div>

        <!-- Data Selection -->
        <div class="mb-6">
            <h3 class="text-lg font-medium text-gray-700 text-center mb-3">Dados para extrair:</h3>
            <div class="flex justify-center space-x-6">
                <label class="flex items-center cursor-pointer">
                    <input type="checkbox" id="select-idade" class="form-checkbox h-4 w-4 text-blue-600" checked>
                    <span class="ml-2">Idade</span>
                </label>
                <label class="flex items-center cursor-pointer">
                    <input type="checkbox" id="select-email" class="form-checkbox h-4 w-4 text-blue-600" checked>
                    <span class="ml-2">E-mail</span>
                </label>
                <label class="flex items-center cursor-pointer">
                    <input type="checkbox" id="select-contatos" class="form-checkbox h-4 w-4 text-blue-600" checked>
                    <span class="ml-2">Contatos</span>
                </label>
            </div>
        </div>

        <!-- Action Button -->
        <div class="text-center mb-8">
            <button id="processButton" class="bg-green-600 text-white font-bold py-3 px-8 rounded-lg shadow-lg hover:bg-green-700 disabled:bg-gray-400 disabled:cursor-not-allowed transition transform hover:scale-105" disabled>
                üöÄ Processar em Lote
            </button>
        </div>

        <!-- Batch Status -->
        <div id="batchStatus" class="hidden mb-8">
            <div class="batch-status text-white p-6 rounded-xl">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-xl font-semibold">Processamento em Lote</h3>
                    <div id="statusBadge" class="px-3 py-1 bg-white bg-opacity-20 rounded-full text-sm font-medium">
                        Iniciando...
                    </div>
                </div>
                
                <div class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-4 text-center">
                    <div>
                        <div id="totalJobs" class="text-2xl font-bold">0</div>
                        <div class="text-sm opacity-90">Total</div>
                    </div>
                    <div>
                        <div id="pendingJobs" class="text-2xl font-bold text-yellow-200">0</div>
                        <div class="text-sm opacity-90">Pendentes</div>
                    </div>
                    <div>
                        <div id="processingJobs" class="text-2xl font-bold text-blue-200">0</div>
                        <div class="text-sm opacity-90">Processando</div>
                    </div>
                    <div>
                        <div id="completedJobs" class="text-2xl font-bold text-green-200">0</div>
                        <div class="text-sm opacity-90">Conclu√≠dos</div>
                    </div>
                    <div>
                        <div id="failedJobs" class="text-2xl font-bold text-red-200">0</div>
                        <div class="text-sm opacity-90">Falharam</div>
                    </div>
                </div>

                <div class="w-full bg-white bg-opacity-20 rounded-full h-3 mb-2">
                    <div id="progressBar" class="progress-bar bg-white h-3 rounded-full" style="width: 0%"></div>
                </div>
                <div id="progressText" class="text-center text-sm opacity-90">0% conclu√≠do</div>
                
                <div id="etaContainer" class="hidden mt-3 text-center text-sm opacity-75">
                    Tempo estimado: <span id="etaText">calculando...</span>
                </div>
            </div>
        </div>

        <!-- Results Section -->
        <div id="results" class="hidden">
            <div class="flex justify-between items-center border-b pb-2 mb-6">
                <h2 class="text-2xl font-semibold text-gray-800">Resultados Extra√≠dos</h2>
                <button id="downloadButton" class="bg-green-600 text-white font-semibold py-2 px-6 rounded-lg shadow-md hover:bg-green-700 flex items-center">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m-1 5.5V21a3.5 3.5 0 01-7 0v-.5m14 0v.5a3.5 3.5 0 01-7 0v-.5"></path>
                    </svg>
                    Baixar Excel
                </button>
            </div>
            <div id="resultsTable" class="overflow-x-auto"></div>
        </div>

        <!-- Error Messages -->
        <div id="errorContainer" class="hidden mt-4 bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded">
            <div class="flex">
                <div class="flex-shrink-0">
                    <svg class="h-5 w-5 text-red-400" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path>
                    </svg>
                </div>
                <div class="ml-3">
                    <h3 class="text-sm font-medium">Erro no processamento</h3>
                    <div id="errorMessage" class="mt-2 text-sm"></div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, where, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        
        const { pdfjsLib } = globalThis;
        pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdn.jsdelivr.net/npm/pdfjs-dist@4.4.168/build/pdf.worker.min.mjs`;

        // Firebase config
        const firebaseConfig = {
          apiKey: "AIzaSyD_awev3z5vRqoIEC52GHJfxl32pzfteE0",
          authDomain: "pdf-extrator.firebaseapp.com",
          projectId: "pdf-extrator",
          storageBucket: "pdf-extrator.appspot.com",
          messagingSenderId: "1083062925751",
          appId: "1:1083062925751:web:384523e9beb7362bbd5032",
          measurementId: "G-29B954MXCN"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // UI Elements
        const ui = {
            fileInput: document.getElementById('pdfFiles'),
            fileCount: document.getElementById('fileCount'),
            processButton: document.getElementById('processButton'),
            batchStatus: document.getElementById('batchStatus'),
            statusBadge: document.getElementById('statusBadge'),
            totalJobs: document.getElementById('totalJobs'),
            pendingJobs: document.getElementById('pendingJobs'),
            processingJobs: document.getElementById('processingJobs'),
            completedJobs: document.getElementById('completedJobs'),
            failedJobs: document.getElementById('failedJobs'),
            progressBar: document.getElementById('progressBar'),
            progressText: document.getElementById('progressText'),
            etaContainer: document.getElementById('etaContainer'),
            etaText: document.getElementById('etaText'),
            results: document.getElementById('results'),
            resultsTable: document.getElementById('resultsTable'),
            downloadButton: document.getElementById('downloadButton'),
            errorContainer: document.getElementById('errorContainer'),
            errorMessage: document.getElementById('errorMessage'),
            selectors: {
                idade: document.getElementById('select-idade'),
                email: document.getElementById('select-email'),
                contatos: document.getElementById('select-contatos')
            }
        };

        // State
        let userId = localStorage.getItem('userId') || `user_${Math.random().toString(36).substr(2, 9)}`;
        localStorage.setItem('userId', userId);
        let selectedFiles = [];
        let extractedData = [];
        let statusChecker = null;
        let startTime = null;

        // Event Listeners
        ui.fileInput.addEventListener('change', handleFileSelection);
        ui.processButton.addEventListener('click', startBatchProcessing);
        ui.downloadButton.addEventListener('click', downloadExcel);

        function handleFileSelection(e) {
            selectedFiles = Array.from(e.target.files);
            
            if (selectedFiles.length > 0) {
                ui.fileCount.textContent = `${selectedFiles.length} arquivo(s) selecionado(s)`;
                ui.processButton.disabled = false;
                
                if (selectedFiles.length > 200) {
                    showError('M√°ximo de 200 arquivos por vez. Processamento pode ser lento.');
                    ui.fileCount.textContent += ' (Limite: 200 arquivos)';
                }
            } else {
                ui.fileCount.textContent = '';
                ui.processButton.disabled = true;
            }
            hideError();
        }

        async function startBatchProcessing() {
            if (selectedFiles.length === 0) return;

            ui.processButton.disabled = true;
            ui.batchStatus.classList.remove('hidden');
            ui.results.classList.add('hidden');
            extractedData = [];
            startTime = Date.now();

            try {
                showStatus('Enviando arquivos para a fila...', 'bg-blue-500');
                
                // Get selected fields
                const selectedFields = Object.keys(ui.selectors).filter(key => ui.selectors[key].checked);
                
                // Upload files to queue
                await uploadFilesToQueue(selectedFiles, selectedFields);
                
                showStatus('Processando em lote...', 'bg-green-500');
                
                // Start processing
                await fetch('/api/start-processing', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userId })
                });

                // Start monitoring
                startStatusMonitoring();

            } catch (error) {
                showError(`Erro ao iniciar processamento: ${error.message}`);
                ui.processButton.disabled = false;
            }
        }

        async function uploadFilesToQueue(files, selectedFields) {
            const batchSize = 10; // Process 10 files at a time
            
            for (let i = 0; i < files.length; i += batchSize) {
                const batch = files.slice(i, i + batchSize);
                const promises = batch.map(file => uploadSingleFile(file, selectedFields));
                
                await Promise.all(promises);
                
                // Update progress
                const uploaded = Math.min(i + batchSize, files.length);
                const progress = (uploaded / files.length) * 20; // 20% for upload
                updateProgress(progress, `Enviando arquivo ${uploaded}/${files.length}...`);
            }
        }

        async function uploadSingleFile(file, selectedFields) {
            try {
                const text = await extractTextFromPdf(file);
                
                await addDoc(collection(db, "processing_queue"), {
                    userId: userId,
                    fileName: file.name,
                    text: text,
                    selectedFields: selectedFields,
                    status: 'pending',
                    createdAt: serverTimestamp()
                });
                
            } catch (error) {
                console.error(`Erro ao enviar ${file.name}:`, error);
                // Continue with other files
            }
        }

        async function extractTextFromPdf(file) {
            return new Promise((resolve, reject) => {
                const fileReader = new FileReader();
                
                fileReader.onload = async (e) => {
                    try {
                        const typedarray = new Uint8Array(e.target.result);
                        const pdf = await pdfjsLib.getDocument({ data: typedarray }).promise;
                        
                        let fullText = '';
                        const maxPages = Math.min(pdf.numPages, 3); // Only first 3 pages for speed
                        
                        for (let i = 1; i <= maxPages; i++) {
                            const page = await pdf.getPage(i);
                            const textContent = await page.getTextContent();
                            fullText += textContent.items.map(item => item.str).join(' ') + ' ';
                        }
                        
                        resolve(fullText.trim());
                    } catch (err) {
                        reject(err);
                    }
                };
                
                fileReader.onerror = () => reject(new Error('N√£o foi poss√≠vel ler o arquivo.'));
                fileReader.readAsArrayBuffer(file);
            });
        }

        function startStatusMonitoring() {
            // Check status every 2 seconds
            statusChecker = setInterval(async () => {
                try {
                    const response = await fetch(`/api/queue-status?userId=${userId}`);
                    const status = await response.json();
                    
                    updateStatusDisplay(status);
                    
                    if (status.isComplete) {
                        clearInterval(statusChecker);
                        await loadResults();
                        showStatus('Processamento conclu√≠do!', 'bg-green-600');
                        ui.processButton.disabled = false;
                    }
                    
                } catch (error) {
                    console.error('Erro ao verificar status:', error);
                }
            }, 2000);

            // Also listen for real-time updates
            const q = query(collection(db, "processing_queue"), where('userId', '==', userId));
            onSnapshot(q, (snapshot) => {
                snapshot.docChanges().forEach((change) => {
                    if (change.type === 'modified') {
                        const job = change.doc.data();
                        if (job.status === 'completed' && job.result) {
                            const existing = extractedData.findIndex(d => d.jobId === change.doc.id);
                            if (existing === -1) {
                                extractedData.push({
                                    ...job.result,
                                    jobId: change.doc.id,
                                    fileName: job.fileName
                                });
                            }
                        }
                    }
                });
            });
        }

        function updateStatusDisplay(status) {
            ui.totalJobs.textContent = status.total || 0;
            ui.pendingJobs.textContent = status.pending || 0;
            ui.processingJobs.textContent = status.processing || 0;
            ui.completedJobs.textContent = status.completed || 0;
            ui.failedJobs.textContent = status.failed || 0;

            const progress = status.progress || 0;
            updateProgress(progress, `${progress}% conclu√≠do`);

            // Calculate ETA
            if (startTime && progress > 0 && progress < 100) {
                const elapsed = Date.now() - startTime;
                const estimated = (elapsed / progress) * (100 - progress);
                const eta = Math.round(estimated / 1000 / 60); // minutes
                
                ui.etaContainer.classList.remove('hidden');
                ui.etaText.textContent = eta > 60 ? `${Math.round(eta/60)}h ${eta%60}m` : `${eta}m`;
            }
        }

        function updateProgress(progress, text) {
            ui.progressBar.style.width = `${Math.max(progress, 5)}%`;
            ui.progressText.textContent = text;
        }

        async function loadResults() {
            if (extractedData.length === 0) return;

            const selectedFields = Object.keys(ui.selectors).filter(key => ui.selectors[key].checked);
            
            // Create table
            let tableHtml = `
                <table class="min-w-full bg-white border border-gray-200 rounded-lg">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Nome</th>
            `;
            
            if (selectedFields.includes('idade')) {
                tableHtml += `<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Idade</th>`;
            }
            if (selectedFields.includes('email')) {
                tableHtml += `<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">E-mail</th>`;
            }
            if (selectedFields.includes('contatos')) {
                tableHtml += `<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Contatos</th>`;
            }
            
            tableHtml += `
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Arquivo</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-200">
            `;

            // Add rows
            extractedData.forEach(data => {
                tableHtml += `<tr class="hover:bg-gray-50">`;
                tableHtml += `<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${data.nome || 'N/A'}</td>`;
                
                if (selectedFields.includes('idade')) {
                    tableHtml += `<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${data.idade > 0 ? data.idade + ' anos' : 'N/A'}</td>`;
                }
                if (selectedFields.includes('email')) {
                    tableHtml += `<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${data.email || 'N/A'}</td>`;
                }
                if (selectedFields.includes('contatos')) {
                    const contatos = Array.isArray(data.contatos) ? data.contatos.join(', ') : (data.contatos || 'N/A');
                    tableHtml += `<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${contatos}</td>`;
                }
                
                tableHtml += `<td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${data.fileName}</td>`;
                tableHtml += `</tr>`;
            });

            tableHtml += `</tbody></table>`;
            
            ui.resultsTable.innerHTML = tableHtml;
            ui.results.classList.remove('hidden');
        }

        function downloadExcel() {
            if (extractedData.length === 0) return;

            const selectedFields = Object.keys(ui.selectors).filter(key => ui.selectors[key].checked);
            
            const excelData = extractedData.map(item => {
                const row = { Nome: item.nome || 'N/A' };
                
                if (selectedFields.includes('idade')) {
                    row.Idade = item.idade > 0 ? item.idade + ' anos' : 'N/A';
                }
                if (selectedFields.includes('email')) {
                    row['E-mail'] = item.email || 'N/A';
                }
                if (selectedFields.includes('contatos')) {
                    row.Contatos = Array.isArray(item.contatos) ? item.contatos.join(', ') : (item.contatos || 'N/A');
                }
                
                row.Arquivo = item.fileName;
                return row;
            });

            const ws = XLSX.utils.json_to_sheet(excelData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Curr√≠culos Extra√≠dos");
            
            const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
            XLSX.writeFile(wb, `curriculos_lote_${timestamp}.xlsx`);
        }

        function showStatus(message, bgClass) {
            ui.statusBadge.textContent = message;
            ui.statusBadge.className = `px-3 py-1 ${bgClass} text-white rounded-full text-sm font-medium`;
        }

        function showError(message) {
            ui.errorMessage.textContent = message;
            ui.errorContainer.classList.remove('hidden');
        }

        function hideError() {
            ui.errorContainer.classList.add('hidden');
        }
    </script>
</body>
</html>