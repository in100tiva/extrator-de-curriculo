<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Extrator de Dados de Currículos (PDF)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .file-input-button {
            cursor: pointer;
            padding: 0.75rem 1.5rem;
            background-color: #4f46e5;
            color: white;
            border-radius: 0.5rem;
            transition: background-color 0.3s;
            font-weight: 500;
        }
        .file-input-button:hover {
            background-color: #4338ca;
        }
        #fileName {
            margin-top: 1rem;
            color: #4b5563;
            font-style: italic;
        }
        table th, table td {
            text-align: left;
            padding: 12px 16px;
        }
        .sortable-header {
            cursor: pointer;
            user-select: none;
        }
        .sortable-header:hover {
            background-color: #f9fafb;
        }
        .sort-icon {
            display: inline-block;
            margin-left: 8px;
            opacity: 0.5;
            transition: opacity 0.2s, transform 0.2s;
        }
        .sortable-header.sorted .sort-icon {
            opacity: 1;
        }
        .sortable-header.sorted.asc .sort-icon {
            transform: rotate(0deg);
        }
        .sortable-header.sorted.desc .sort-icon {
            transform: rotate(180deg);
        }
        #progress-bar {
            transition: width 0.3s ease-in-out;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">

    <div class="w-full max-w-5xl mx-auto bg-white rounded-2xl shadow-lg p-8">
        <header class="text-center mb-8">
            <h1 class="text-3xl font-bold text-gray-800">Extrator de Dados de Currículos</h1>
            <p class="text-gray-600 mt-2">Faça o upload de um ou mais currículos em PDF para extrair os dados em uma tabela.</p>
        </header>

        <main>
            <!-- File Upload Section -->
            <div class="text-center mb-6">
                <label for="pdfFile" class="file-input-button">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block mr-2" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM6.293 6.707a1 1 0 010-1.414l3-3a1 1 0 011.414 0l3 3a1 1 0 01-1.414 1.414L11 5.414V13a1 1 0 11-2 0V5.414L7.707 6.707a1 1 0 01-1.414 0z" clip-rule="evenodd" />
                    </svg>
                    Escolher Arquivo(s) PDF
                </label>
                <input type="file" id="pdfFile" accept=".pdf" class="hidden" multiple>
                <p id="fileName" class="text-sm"></p>
            </div>

             <!-- Data Selector Section -->
            <div class="mb-6">
                <h3 class="text-lg font-medium text-gray-700 text-center mb-3">Selecione os dados para extrair:</h3>
                <div class="flex justify-center items-center space-x-6 text-gray-600">
                    <label class="flex items-center cursor-pointer">
                        <input type="checkbox" id="select-idade" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500" checked>
                        <span class="ml-2">Idade</span>
                    </label>
                    <label class="flex items-center cursor-pointer">
                        <input type="checkbox" id="select-email" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500" checked>
                        <span class="ml-2">E-mail</span>
                    </label>
                    <label class="flex items-center cursor-pointer">
                        <input type="checkbox" id="select-contatos" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500" checked>
                        <span class="ml-2">Contatos</span>
                    </label>
                </div>
            </div>

            <!-- Action Button -->
            <div class="text-center mb-8">
                <button id="extractButton" class="bg-indigo-600 text-white font-semibold py-3 px-8 rounded-lg shadow-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-transform transform hover:scale-105 disabled:bg-gray-400 disabled:cursor-not-allowed disabled:scale-100" disabled>
                    Extrair Informações
                </button>
                 <div id="progress-section" class="mt-4 hidden">
                    <p id="estimation-info" class="text-sm text-gray-600 text-center"></p>
                    <div id="progress-container" class="w-full bg-gray-200 rounded-full h-2.5 mt-2">
                        <div id="progress-bar" class="bg-indigo-600 h-2.5 rounded-full" style="width: 0%"></div>
                    </div>
                </div>
            </div>

            <!-- Results Section -->
            <div id="results" class="hidden">
                <h2 class="text-2xl font-semibold text-gray-800 border-b pb-2 mb-6">Dados Extraídos</h2>
                <div id="loader" class="text-center hidden my-4">
                    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600 mx-auto"></div>
                    <p id="loader-text" class="mt-3 text-gray-600">Analisando currículos...</p>
                </div>
                <div id="output" class="space-y-4">
                    <!-- Table will be inserted here -->
                </div>
                 <!-- Pagination Controls -->
                <div id="pagination-controls" class="hidden mt-6 flex items-center justify-between">
                    <span id="page-info" class="text-sm text-gray-700"></span>
                    <div>
                        <button id="prev-page" class="bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300 disabled:bg-gray-100 disabled:text-gray-400 disabled:cursor-not-allowed">
                            Anterior
                        </button>
                        <button id="next-page" class="ml-2 bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-700 disabled:bg-gray-400 disabled:cursor-not-allowed">
                            Próxima
                        </button>
                    </div>
                </div>
            </div>

             <!-- Error Message -->
            <div id="error-container" class="hidden mt-4 bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg relative" role="alert">
                <strong class="font-bold">Erro:</strong>
                <span class="block sm:inline" id="error-message"></span>
            </div>
        </main>
    </div>

    <script type="module">
        import * as pdfjsLib from 'https://mozilla.github.io/pdf.js/build/pdf.mjs';

        // PDF.js worker setup
        pdfjsLib.GlobalWorkerOptions.workerSrc = `https://mozilla.github.io/pdf.js/build/pdf.worker.mjs`;
        
        const pdfFileInput = document.getElementById('pdfFile');
        const fileNameDisplay = document.getElementById('fileName');
        const extractButton = document.getElementById('extractButton');
        const progressSection = document.getElementById('progress-section');
        const estimationInfo = document.getElementById('estimation-info');
        const progressBar = document.getElementById('progress-bar');
        const resultsDiv = document.getElementById('results');
        const loader = document.getElementById('loader');
        const loaderText = document.getElementById('loader-text');
        const outputDiv = document.getElementById('output');
        const errorContainer = document.getElementById('error-container');
        const errorMessage = document.getElementById('error-message');
        const prevPageButton = document.getElementById('prev-page');
        const nextPageButton = document.getElementById('next-page');

        const selectors = {
            idade: document.getElementById('select-idade'),
            email: document.getElementById('select-email'),
            contatos: document.getElementById('select-contatos'),
        };

        let allExtractedData = [];
        let sortState = { key: null, direction: 'asc' };
        let currentSelectedFields = [];
        let currentPage = 1;
        let estimationInterval = null;
        const ITEMS_PER_PAGE = 10;

        pdfFileInput.addEventListener('change', (event) => {
            const files = event.target.files;
            if (files.length > 0) {
                fileNameDisplay.textContent = `${files.length} arquivo(s) selecionado(s).`;
                extractButton.disabled = false;
                hideError();
            } else {
                fileNameDisplay.textContent = 'Nenhum arquivo selecionado.';
                extractButton.disabled = true;
            }
        });

        extractButton.addEventListener('click', async () => {
            const files = pdfFileInput.files;
            if (!files || files.length === 0) {
                showError('Nenhum arquivo selecionado.');
                return;
            }
            
            allExtractedData = [];
            sortState = { key: null, direction: 'asc' };
            currentPage = 1;
            currentSelectedFields = Object.keys(selectors).filter(key => selectors[key].checked);
            if (estimationInterval) clearInterval(estimationInterval);

            resultsDiv.classList.remove('hidden');
            loader.classList.remove('hidden');
            progressSection.classList.add('hidden');
            document.getElementById('pagination-controls').classList.add('hidden');
            extractButton.disabled = true;
            hideError();
            setupTable(currentSelectedFields);

            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                loaderText.textContent = `Analisando arquivo ${i + 1} de ${files.length}: ${file.name}`;
                
                try {
                    const startTime = performance.now();
                    const text = await extractTextFromPdf(file);
                    const data = await callGeminiAPI(text, currentSelectedFields);
                    const endTime = performance.now();

                    if (data) {
                        allExtractedData.push({ ...data, fileName: file.name });
                        renderTable();
                    }
                    
                    const progress = ((i + 1) / files.length) * 100;
                    progressBar.style.width = `${progress}%`;

                    if (i === 0 && files.length > 1) {
                        const duration = endTime - startTime;
                        const remainingFiles = files.length - 1;
                        const estimatedTime = duration * remainingFiles;
                        startEstimationTimer(estimatedTime);
                    }

                } catch (err) {
                    console.error(`Error processing file ${file.name}:`, err);
                    showError(`Falha ao processar o arquivo ${file.name}.`);
                    break; 
                } finally {
                    if (i < files.length - 1) {
                       await new Promise(resolve => setTimeout(resolve, 1500));
                    }
                }
            }

            loader.classList.add('hidden');
            progressSection.classList.add('hidden');
            if (estimationInterval) clearInterval(estimationInterval);
            extractButton.disabled = false;
        });

        function startEstimationTimer(initialTime) {
            progressSection.classList.remove('hidden');
            let estimationEndTime = Date.now() + initialTime;
            
            if (estimationInterval) clearInterval(estimationInterval);

            estimationInterval = setInterval(() => {
                const remainingTime = estimationEndTime - Date.now();
                if (remainingTime <= 0) {
                    estimationInfo.textContent = "Finalizando...";
                    clearInterval(estimationInterval);
                } else {
                    updateEstimationText(remainingTime);
                }
            }, 1000);
        }

        function updateEstimationText(timeInMs) {
            const seconds = Math.round(timeInMs / 1000);
            let timeString;
            if (seconds < 60) {
                timeString = `${seconds} segundos`;
            } else {
                const minutes = Math.floor(seconds / 60);
                const remainingSeconds = seconds % 60;
                timeString = `${minutes} minuto(s)${remainingSeconds > 0 ? ` e ${remainingSeconds} segundo(s)` : ''}`;
            }
            estimationInfo.textContent = `Aguarde, extraindo dados... Tempo restante estimado: ${timeString}.`;
        }

        prevPageButton.addEventListener('click', () => {
            if (currentPage > 1) {
                currentPage--;
                renderTable();
            }
        });

        nextPageButton.addEventListener('click', () => {
            const totalPages = Math.ceil(allExtractedData.length / ITEMS_PER_PAGE);
            if (currentPage < totalPages) {
                currentPage++;
                renderTable();
            }
        });

        async function extractTextFromPdf(file) {
            return new Promise((resolve, reject) => {
                const fileReader = new FileReader();
                fileReader.onload = async (e) => {
                    try {
                        const typedarray = new Uint8Array(e.target.result);
                        const pdf = await pdfjsLib.getDocument({ data: typedarray }).promise;
                        let fullText = '';
                        for (let i = 1; i <= pdf.numPages; i++) {
                            const page = await pdf.getPage(i);
                            const textContent = await page.getTextContent();
                            const pageText = textContent.items.map(item => item.str).join(' ');
                            fullText += pageText + '\n\n';
                        }
                        resolve(fullText);
                    } catch (pdfError) {
                        reject(pdfError);
                    }
                };
                fileReader.onerror = () => reject(new Error('Não foi possível ler o arquivo.'));
                fileReader.readAsArrayBuffer(file);
            });
        }
        
        async function callGeminiAPI(text, selectedFields) {
            const apiUrl = `/api/proxy`;
            const currentYear = new Date().getFullYear();

            const systemPrompt = `Você é um assistente de RH de elite, focado em extrair dados de textos de currículos com alta precisão.

REGRAS CRÍTICAS DE EXTRAÇÃO:
1.  **NOME**: Extraia o nome completo que geralmente aparece no topo. SEMPRE formate o nome para que a primeira letra de cada palavra seja maiúscula, exceto para conectivos como "de", "da", "do", "dos" que devem ser minúsculos. Exemplo: "RAQUEL DE OLIVEIRA SILVA" deve se tornar "Raquel de Oliveira Silva".
2.  **IDADE**:
    - PRIMEIRO, procure por um número seguido diretamente pela palavra "anos" (ex: "37 anos").
    - SE NÃO ENCONTRAR, procure por uma data de nascimento (DD/MM/AAAA) e calcule a idade (ano atual: ${currentYear}).
    - Se nenhum método funcionar, retorne 0.
3.  **CONTATOS**:
    - Extraia TODOS os números de telefone. Preste atenção em números próximos a "WhatsApp", "Celular", "Fone".
    - Ignore outros números que não sejam telefones (ex: datas de experiência).
4.  **EMAIL**: Encontre o e-mail, que sempre contém "@".
5.  **FORMATAÇÃO DE CONTATO**: Todos os números de telefone devem ser formatados para o padrão (DD) 9 XXXX-XXXX. Se não tiver 9 dígitos no corpo, use (DD) XXXX-XXXX.
6.  **SAÍDA**: Responda APENAS com o objeto JSON, sem nenhum texto extra. Siga o esquema JSON rigorosamente.`;
            
            const userPrompt = `Extraia as informações do seguinte texto de currículo:\n\n--- INÍCIO DO CURRÍCULO ---\n${text}\n--- FIM DO CURRÍCULO ---`;
            
            const properties = { nome: { type: "STRING", description: "O nome completo do candidato, formatado." } };
            const required = ["nome"];

            if (selectedFields.includes('idade')) {
                properties.idade = { type: "NUMBER", description: "A idade do candidato. Retorne 0 se não encontrada." };
                required.push('idade');
            }
            if (selectedFields.includes('email')) {
                properties.email = { type: "STRING", description: "O e-mail do candidato. Retorne string vazia se não encontrado." };
                required.push('email');
            }
            if (selectedFields.includes('contatos')) {
                properties.contatos = { type: "ARRAY", description: "Lista de telefones formatados para (DD) 9 XXXX-XXXX.", items: { type: "STRING" } };
                required.push('contatos');
            }

            const payload = {
                contents: [{ parts: [{ text: userPrompt }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: { type: "OBJECT", properties, required }
                }
            };

            try {
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) throw new Error(`API Error: ${response.status}`);
                const result = await response.json();
                const candidate = result.candidates?.[0];
                if (candidate?.content?.parts?.[0]?.text) {
                    return JSON.parse(candidate.content.parts[0].text);
                }
                throw new Error('Resposta da API inválida.');
            } catch (error) {
                console.error("Error calling Gemini API:", error);
                showError(`Falha ao comunicar com a API. Detalhes: ${error.message}`);
                return null;
            }
        }

        function setupTable(selectedFields) {
            const headers = [
                { key: 'fileName', label: 'Arquivo', sortable: false },
                { key: 'nome', label: 'Nome', sortable: true },
                ...(selectedFields.map(f => ({ key: f, label: f.charAt(0).toUpperCase() + f.slice(1), sortable: true })))
            ];
            
            const iconSvg = `<svg class="sort-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8 15a.5.5 0 0 0 .5-.5V2.707l3.146 3.147a.5.5 0 0 0 .708-.708l-4-4a.5.5 0 0 0-.708 0l-4 4a.5.5 0 1 0 .708.708L7.5 2.707V14.5a.5.5 0 0 0 .5.5z"/></svg>`;
            
            const headerHtml = headers.map(h => {
                if (h.sortable) {
                    return `<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sortable-header" data-sort-key="${h.key}">${h.label}${iconSvg}</th>`;
                }
                return `<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">${h.label}</th>`;
            }).join('');

            outputDiv.innerHTML = `
                <div class="overflow-x-auto border border-gray-200 rounded-lg">
                    <table class="min-w-full bg-white">
                        <thead class="bg-gray-50">
                            <tr>${headerHtml}</tr>
                        </thead>
                        <tbody class="divide-y divide-gray-200">
                        </tbody>
                    </table>
                </div>`;
            
            document.querySelectorAll('.sortable-header').forEach(header => {
                header.addEventListener('click', () => {
                    const key = header.dataset.sortKey;
                    if (sortState.key === key) {
                        sortState.direction = sortState.direction === 'asc' ? 'desc' : 'asc';
                    } else {
                        sortState.key = key;
                        sortState.direction = 'asc';
                    }
                    currentPage = 1;
                    renderTable();
                });
            });
        }
        
        function sortData() {
            const { key, direction } = sortState;
            if (!key) return;

            allExtractedData.sort((a, b) => {
                let valA = a[key];
                let valB = b[key];
                const factor = direction === 'asc' ? 1 : -1;

                // Priority sorting for specific columns
                if (key === 'idade') {
                    const aHasAge = valA > 0;
                    const bHasAge = valB > 0;
                    if (aHasAge && !bHasAge) return -1;
                    if (!aHasAge && bHasAge) return 1;
                    return (valA - valB) * factor;
                }
                if (key === 'email') {
                    const aHasEmail = valA && valA.length > 0;
                    const bHasEmail = valB && valB.length > 0;
                    if (aHasEmail && !bHasEmail) return -1;
                    if (!aHasEmail && bHasEmail) return 1;
                }
                if (key === 'contatos') {
                    const aHasContatos = valA && valA.length > 0;
                    const bHasContatos = valB && bHasContatos > 0;
                    if (aHasContatos && !bHasContatos) return -1;
                    if (!aHasContatos && bHasContatos) return 1;
                }

                // Default string/number sort
                if (typeof valA === 'string') {
                    return valA.localeCompare(valB) * factor;
                }
                if (typeof valA === 'number') {
                    return (valA - valB) * factor;
                }
                return 0;
            });
        }

        function renderTable() {
            sortData();

            const tableBody = document.querySelector('#output tbody');
            if (!tableBody) return;
            
            tableBody.innerHTML = ''; // Clear existing rows

            const startIndex = (currentPage - 1) * ITEMS_PER_PAGE;
            const endIndex = startIndex + ITEMS_PER_PAGE;
            const paginatedData = allExtractedData.slice(startIndex, endIndex);

            paginatedData.forEach(data => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';

                let cells = `<td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-800">${data.fileName}</td>
                             <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${data.nome || 'Não encontrado'}</td>`;

                if (currentSelectedFields.includes('idade')) {
                    cells += `<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${data.idade > 0 ? data.idade : 'N/A'}</td>`;
                }
                if (currentSelectedFields.includes('email')) {
                    cells += `<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${data.email || 'N/A'}</td>`;
                }
                if (currentSelectedFields.includes('contatos')) {
                    cells += `<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${data.contatos?.join(', ') || 'N/A'}</td>`;
                }

                row.innerHTML = cells;
                tableBody.appendChild(row);
            });
            
            document.querySelectorAll('.sortable-header').forEach(header => {
                header.classList.remove('sorted', 'asc', 'desc');
                if (header.dataset.sortKey === sortState.key) {
                    header.classList.add('sorted', sortState.direction);
                }
            });

            renderPaginationControls();
        }

        function renderPaginationControls() {
            const pageInfo = document.getElementById('page-info');
            const paginationControls = document.getElementById('pagination-controls');
            const totalItems = allExtractedData.length;
            const totalPages = Math.ceil(totalItems / ITEMS_PER_PAGE);

            if (totalPages <= 1) {
                paginationControls.classList.add('hidden');
                return;
            }

            paginationControls.classList.remove('hidden');
            pageInfo.textContent = `Página ${currentPage} de ${totalPages}`;
            prevPageButton.disabled = currentPage === 1;
            nextPageButton.disabled = currentPage === totalPages;
        }

        function showError(message) {
            errorMessage.textContent = message;
            errorContainer.classList.remove('hidden');
        }

        function hideError() {
            errorContainer.classList.add('hidden');
        }
    </script>
</body>
</html>

