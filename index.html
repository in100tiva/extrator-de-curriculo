<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Extrator de Dados de Currículos (PDF)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@4.4.168/build/pdf.min.mjs" type="module"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .file-input-button { cursor: pointer; padding: 0.75rem 1.5rem; background-color: #4f46e5; color: white; border-radius: 0.5rem; transition: background-color 0.3s; font-weight: 500; }
        .file-input-button:hover { background-color: #4338ca; }
        table th, table td { text-align: left; padding: 12px 16px; }
        .sortable-header { cursor: pointer; user-select: none; }
        .sort-icon { display: inline-block; margin-left: 8px; opacity: 0.5; transition: opacity 0.2s, transform 0.2s; }
        .sortable-header.sorted .sort-icon { opacity: 1; }
        .sortable-header.sorted.asc .sort-icon { transform: rotate(0deg); }
        .sortable-header.sorted.desc .sort-icon { transform: rotate(180deg); }
        #progress-bar { transition: width 0.3s ease-in-out; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">

    <div class="w-full max-w-5xl mx-auto bg-white rounded-2xl shadow-lg p-8">
        <header class="text-center mb-8">
            <h1 class="text-3xl font-bold text-gray-800">Extrator de Dados de Currículos</h1>
            <p class="text-gray-600 mt-2">Faça o upload de um ou mais currículos em PDF para extrair os dados de forma rápida e segura.</p>
        </header>

        <main>
            <div class="text-center mb-6">
                <label for="pdfFile" class="file-input-button">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM6.293 6.707a1 1 0 010-1.414l3-3a1 1 0 011.414 0l3 3a1 1 0 01-1.414 1.414L11 5.414V13a1 1 0 11-2 0V5.414L7.707 6.707a1 1 0 01-1.414 0z" clip-rule="evenodd" /></svg>
                    Escolher Arquivo(s) PDF
                </label>
                <input type="file" id="pdfFile" accept=".pdf" class="hidden" multiple>
                <p id="fileName" class="text-sm mt-4"></p>
            </div>

            <div class="mb-6">
                <h3 class="text-lg font-medium text-gray-700 text-center mb-3">Selecione os dados para extrair:</h3>
                <div class="flex justify-center items-center space-x-6 text-gray-600">
                    <label class="flex items-center cursor-pointer"><input type="checkbox" id="select-idade" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500" checked><span class="ml-2">Idade</span></label>
                    <label class="flex items-center cursor-pointer"><input type="checkbox" id="select-email" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500" checked><span class="ml-2">E-mail</span></label>
                    <label class="flex items-center cursor-pointer"><input type="checkbox" id="select-contatos" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500" checked><span class="ml-2">Contatos</span></label>
                </div>
            </div>

            <div class="text-center mb-8">
                <button id="extractButton" class="bg-indigo-600 text-white font-semibold py-3 px-8 rounded-lg shadow-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-transform transform hover:scale-105 disabled:bg-gray-400 disabled:cursor-not-allowed disabled:scale-100" disabled>
                    Extrair Informações
                </button>
            </div>
            
            <div id="progress-section" class="hidden my-4">
                <p id="progress-text" class="text-sm text-gray-600 text-center"></p>
                <div class="w-full bg-gray-200 rounded-full h-2.5 mt-2">
                    <div id="progress-bar" class="bg-indigo-600 h-2.5 rounded-full" style="width: 0%"></div>
                </div>
            </div>

            <div id="results" class="hidden">
                <div class="flex justify-between items-center border-b pb-2 mb-6">
                    <h2 class="text-2xl font-semibold text-gray-800">Dados Extraídos</h2>
                    <button id="downloadExcelButton" class="hidden bg-green-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-green-700">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
                        Baixar como Excel
                    </button>
                </div>
                <div id="output"></div>
                <div id="pagination-controls" class="hidden mt-6 flex items-center justify-between">
                    <span id="page-info" class="text-sm text-gray-700"></span>
                    <div>
                        <button id="prev-page" class="bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-lg">Anterior</button>
                        <button id="next-page" class="ml-2 bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg">Próxima</button>
                    </div>
                </div>
            </div>

            <div id="error-container" class="hidden mt-4 bg-red-100 border-red-400 text-red-700 px-4 py-3 rounded-lg">
                <strong class="font-bold">Erro:</strong>
                <span id="error-message"></span>
            </div>
        </main>
    </div>

    <script type="module">
        const { pdfjsLib } = globalThis;
        pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdn.jsdelivr.net/npm/pdfjs-dist@4.4.168/build/pdf.worker.min.mjs`;
        
        const ui = {};
        // Mapping UI elements
        Object.assign(ui, {
            pdfFileInput: document.getElementById('pdfFile'),
            fileNameDisplay: document.getElementById('fileName'),
            extractButton: document.getElementById('extractButton'),
            progressSection: document.getElementById('progress-section'),
            progressText: document.getElementById('progress-text'),
            progressBar: document.getElementById('progress-bar'),
            resultsDiv: document.getElementById('results'),
            outputDiv: document.getElementById('output'),
            errorContainer: document.getElementById('error-container'),
            errorMessage: document.getElementById('error-message'),
            prevPage: document.getElementById('prev-page'),
            nextPage: document.getElementById('next-page'),
            pageInfo: document.getElementById('page-info'),
            paginationControls: document.getElementById('pagination-controls'),
            downloadExcelButton: document.getElementById('downloadExcelButton'),
            selectors: {
                idade: document.getElementById('select-idade'),
                email: document.getElementById('select-email'),
                contatos: document.getElementById('select-contatos'),
            }
        });

        let allExtractedData = [];
        let sortState = { key: null, direction: 'asc' };
        let currentPage = 1;
        const ITEMS_PER_PAGE = 10;
        const sleep = (ms) => new Promise(resolve => setTimeout(resolve, ms));

        ui.pdfFileInput.addEventListener('change', (e) => {
            const files = e.target.files;
            ui.fileNameDisplay.textContent = files.length > 0 ? `${files.length} arquivo(s) selecionado(s).` : '';
            ui.extractButton.disabled = files.length === 0;
            hideError();
        });

        ui.extractButton.addEventListener('click', async () => {
            const files = Array.from(ui.pdfFileInput.files);
            if (files.length === 0) return;

            resetState();
            ui.extractButton.disabled = true;
            ui.progressSection.classList.remove('hidden');

            const selectedFields = Object.keys(ui.selectors).filter(key => ui.selectors[key].checked);

            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                ui.progressText.textContent = `Processando arquivo ${i + 1} de ${files.length}: ${file.name}`;
                ui.progressBar.style.width = `${((i + 1) / files.length) * 100}%`;

                try {
                    const text = await extractTextFromPdf(file);
                    const data = await callGeminiAPI(text, selectedFields);
                    if (data) {
                        allExtractedData.push({ ...data, fileName: file.name });
                    } else {
                        throw new Error("Não foi possível extrair dados do arquivo.");
                    }
                    await sleep(1500); // Wait 1.5 seconds to respect API rate limits
                } catch (err) {
                    showError(`Falha ao processar ${file.name}: ${err.message}`);
                    await sleep(2000); // Longer pause on error
                }
            }

            ui.progressSection.classList.add('hidden');
            ui.extractButton.disabled = false;
            if (allExtractedData.length > 0) {
                renderTable();
            }
        });

        async function extractTextFromPdf(file) {
            const fileReader = new FileReader();
            return new Promise((resolve, reject) => {
                fileReader.onload = async (e) => {
                    try {
                        const typedarray = new Uint8Array(e.target.result);
                        const pdf = await pdfjsLib.getDocument({ data: typedarray }).promise;
                        let fullText = '';
                        for (let i = 1; i <= pdf.numPages; i++) {
                            const page = await pdf.getPage(i);
                            const textContent = await page.getTextContent();
                            fullText += textContent.items.map(item => item.str).join(' ');
                        }
                        resolve(fullText);
                    } catch (err) { reject(err); }
                };
                fileReader.onerror = () => reject(new Error('Não foi possível ler o arquivo.'));
                fileReader.readAsArrayBuffer(file);
            });
        }
        
        async function callGeminiAPI(text, selectedFields) {
            const payload = { text, selectedFields };
            const response = await fetch('/api/proxy', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || `Erro do servidor: ${response.status}`);
            }
            return await response.json();
        }

        function resetState() {
            allExtractedData = [];
            sortState = { key: null, direction: 'asc' };
            currentPage = 1;
            ui.resultsDiv.classList.add('hidden');
            ui.outputDiv.innerHTML = '';
            hideError();
        }

        function renderTable() {
            if (!document.querySelector('#output table')) {
                setupTable();
            }
            ui.resultsDiv.classList.remove('hidden');
            if(allExtractedData.length > 0) ui.downloadExcelButton.classList.remove('hidden');
            sortData();

            const tableBody = document.querySelector('#output tbody');
            if (!tableBody) return;
            tableBody.innerHTML = '';
            
            const paginatedData = allExtractedData.slice((currentPage - 1) * ITEMS_PER_PAGE, currentPage * ITEMS_PER_PAGE);

            paginatedData.forEach(data => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                const selectedFields = Object.keys(ui.selectors).filter(key => ui.selectors[key].checked);
                let cells = `<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${data.nome || 'N/A'}</td>`;
                if (selectedFields.includes('idade')) cells += `<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${data.idade > 0 ? data.idade : 'N/A'}</td>`;
                if (selectedFields.includes('email')) cells += `<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${data.email || 'N/A'}</td>`;
                if (selectedFields.includes('contatos')) cells += `<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${data.contatos?.join(', ') || 'N/A'}</td>`;
                cells += `<td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-800">${data.fileName}</td>`;
                row.innerHTML = cells;
                tableBody.appendChild(row);
            });

            document.querySelectorAll('.sortable-header').forEach(h => {
                h.classList.remove('sorted', 'asc', 'desc');
                if (h.dataset.sortKey === sortState.key) {
                    h.classList.add('sorted', sortState.direction);
                }
            });
            renderPaginationControls();
        }

        function setupTable() {
            const selectedFields = Object.keys(ui.selectors).filter(key => ui.selectors[key].checked);
            const headers = [
                { key: 'nome', label: 'Nome', sortable: true },
                ...selectedFields.map(f => ({ key: f, label: f.charAt(0).toUpperCase() + f.slice(1), sortable: true })),
                { key: 'fileName', label: 'Arquivo', sortable: true }
            ];
            const iconSvg = `<svg class="sort-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8 15a.5.5 0 0 0 .5-.5V2.707l3.146 3.147a.5.5 0 0 0 .708-.708l-4-4a.5.5 0 0 0-.708 0l-4 4a.5.5 0 1 0 .708.708L7.5 2.707V14.5a.5.5 0 0 0 .5.5z"/></svg>`;
            const headerHtml = headers.map(h => h.sortable ? `<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sortable-header" data-sort-key="${h.key}">${h.label}${iconSvg}</th>` : `<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">${h.label}</th>`).join('');
            ui.outputDiv.innerHTML = `<div class="overflow-x-auto border border-gray-200 rounded-lg"><table class="min-w-full bg-white"><thead class="bg-gray-50"><tr>${headerHtml}</tr></thead><tbody class="divide-y divide-gray-200"></tbody></table></div>`;
            document.querySelectorAll('.sortable-header').forEach(header => {
                header.addEventListener('click', () => {
                    const key = header.dataset.sortKey;
                    sortState.direction = (sortState.key === key && sortState.direction === 'asc') ? 'desc' : 'asc';
                    sortState.key = key;
                    currentPage = 1;
                    renderTable();
                });
            });
        }
        
        function sortData() {
            if (!sortState.key) return;
            const { key, direction } = sortState;
            const factor = direction === 'asc' ? 1 : -1;

            allExtractedData.sort((a, b) => {
                let valA = a[key];
                let valB = b[key];

                if (valA === undefined || valA === null) valA = '';
                if (valB === undefined || valB === null) valB = '';

                if (key === 'idade') {
                    const aHas = valA > 0;
                    const bHas = valB > 0;
                    if (aHas !== bHas) return aHas ? -1 : 1;
                    return (valA - valB) * factor;
                }
                if (key === 'email' || key === 'contatos') {
                    const aHas = Array.isArray(valA) ? valA.length > 0 : (valA || '').length > 0;
                    const bHas = Array.isArray(valB) ? valB.length > 0 : (valB || '').length > 0;
                    if (aHas !== bHas) return aHas ? -1 : 1;
                }

                if (typeof valA === 'string') {
                    return valA.localeCompare(valB, 'pt-BR') * factor;
                }
                if (typeof valA === 'number') {
                    return (valA - valB) * factor;
                }
                return 0;
            });
        }

        function renderPaginationControls() {
            const totalPages = Math.ceil(allExtractedData.length / ITEMS_PER_PAGE);
            if (totalPages <= 1) {
                ui.paginationControls.classList.add('hidden');
                return;
            }
            ui.paginationControls.classList.remove('hidden');
            ui.pageInfo.textContent = `Página ${currentPage} de ${totalPages}`;
            ui.prevPage.disabled = currentPage === 1;
            ui.nextPage.disabled = currentPage === totalPages;
        }

        ui.prevPage.addEventListener('click', () => { if (currentPage > 1) { currentPage--; renderTable(); } });
        ui.nextPage.addEventListener('click', () => { if (currentPage < Math.ceil(allExtractedData.length / ITEMS_PER_PAGE)) { currentPage++; renderTable(); } });
        
        ui.downloadExcelButton.addEventListener('click', () => {
            const selectedFields = Object.keys(ui.selectors).filter(key => ui.selectors[key].checked);
            const dataToExport = allExtractedData.map(item => {
                const row = { Nome: item.nome || 'N/A' };
                if (selectedFields.includes('idade')) row.Idade = item.idade > 0 ? item.idade : 'N/A';
                if (selectedFields.includes('email')) row['E-mail'] = item.email || 'N/A';
                if (selectedFields.includes('contatos')) row.Contatos = item.contatos?.join(', ') || 'N/A';
                row.Arquivo = item.fileName;
                return row;
            });
            const ws = XLSX.utils.json_to_sheet(dataToExport);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Dados Extraídos");
            XLSX.writeFile(wb, "extracao_curriculos.xlsx");
        });

        function showError(message) { ui.errorMessage.textContent = message; ui.errorContainer.classList.remove('hidden'); }
        function hideError() { ui.errorContainer.classList.add('hidden'); }
    </script>
</body>
</html>

