<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Extrator de Dados de Currículos (PDF)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .file-input-button { cursor: pointer; padding: 0.75rem 1.5rem; background-color: #4f46e5; color: white; border-radius: 0.5rem; transition: background-color 0.3s; font-weight: 500; }
        .file-input-button:hover { background-color: #4338ca; }
        #fileName { margin-top: 1rem; color: #4b5563; font-style: italic; }
        table th, table td { text-align: left; padding: 12px 16px; }
        .sortable-header { cursor: pointer; user-select: none; }
        .sortable-header:hover { background-color: #f9fafb; }
        .sort-icon { display: inline-block; margin-left: 8px; opacity: 0.5; transition: opacity 0.2s, transform 0.2s; }
        .sortable-header.sorted .sort-icon { opacity: 1; }
        .sortable-header.sorted.asc .sort-icon { transform: rotate(0deg); }
        .sortable-header.sorted.desc .sort-icon { transform: rotate(180deg); }
        #progress-bar { transition: width 0.3s ease-in-out; }
        .queue-status-card { background-color: #f3f4f6; border: 1px solid #e5e7eb; border-radius: 0.75rem; padding: 1rem; text-align: center; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">

    <div class="w-full max-w-5xl mx-auto bg-white rounded-2xl shadow-lg p-8">
        <header class="text-center mb-8">
            <h1 class="text-3xl font-bold text-gray-800">Extrator de Dados de Currículos</h1>
            <p class="text-gray-600 mt-2">Faça o upload de um ou mais currículos em PDF para extrair os dados em uma tabela.</p>
        </header>

        <main>
            <!-- File Upload Section -->
            <div class="text-center mb-6">
                <label for="pdfFile" class="file-input-button">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM6.293 6.707a1 1 0 010-1.414l3-3a1 1 0 011.414 0l3 3a1 1 0 01-1.414 1.414L11 5.414V13a1 1 0 11-2 0V5.414L7.707 6.707a1 1 0 01-1.414 0z" clip-rule="evenodd" /></svg>
                    Escolher Arquivo(s) PDF
                </label>
                <input type="file" id="pdfFile" accept=".pdf" class="hidden" multiple>
                <p id="fileName" class="text-sm"></p>
            </div>

            <!-- Data Selector Section -->
            <div class="mb-6">
                <h3 class="text-lg font-medium text-gray-700 text-center mb-3">Selecione os dados para extrair:</h3>
                <div class="flex justify-center items-center space-x-6 text-gray-600">
                    <label class="flex items-center cursor-pointer"><input type="checkbox" id="select-idade" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500" checked><span class="ml-2">Idade</span></label>
                    <label class="flex items-center cursor-pointer"><input type="checkbox" id="select-email" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500" checked><span class="ml-2">E-mail</span></label>
                    <label class="flex items-center cursor-pointer"><input type="checkbox" id="select-contatos" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500" checked><span class="ml-2">Contatos</span></label>
                </div>
            </div>

            <!-- Action Button -->
            <div class="text-center mb-8">
                <button id="extractButton" class="bg-indigo-600 text-white font-semibold py-3 px-8 rounded-lg shadow-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-transform transform hover:scale-105 disabled:bg-gray-400 disabled:cursor-not-allowed disabled:scale-100" disabled>
                    Enviar para a Fila de Extração
                </button>
            </div>

            <!-- Queue Status Section -->
            <div id="queue-status-section" class="hidden mb-8">
                <div class="queue-status-card">
                    <h3 class="text-lg font-semibold text-gray-800">Status da Fila</h3>
                    <p id="queue-position" class="text-gray-600 mt-2"></p>
                    <div id="progress-container" class="w-full bg-gray-200 rounded-full h-2.5 mt-2">
                        <div id="progress-bar" class="bg-indigo-600 h-2.5 rounded-full" style="width: 0%"></div>
                    </div>
                </div>
            </div>

            <!-- Results Section -->
            <div id="results" class="hidden">
                <div class="flex justify-between items-center border-b pb-2 mb-6">
                    <h2 class="text-2xl font-semibold text-gray-800">Dados Extraídos</h2>
                    <button id="downloadExcelButton" class="hidden bg-green-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition-transform transform hover:scale-105">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
                        Baixar como Excel
                    </button>
                </div>
                <div id="output" class="space-y-4"></div>
                <div id="pagination-controls" class="hidden mt-6 flex items-center justify-between">
                    <span id="page-info" class="text-sm text-gray-700"></span>
                    <div>
                        <button id="prev-page" class="bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300 disabled:bg-gray-100 disabled:text-gray-400 disabled:cursor-not-allowed">Anterior</button>
                        <button id="next-page" class="ml-2 bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-700 disabled:bg-gray-400 disabled:cursor-not-allowed">Próxima</button>
                    </div>
                </div>
            </div>

             <!-- Error Message -->
            <div id="error-container" class="hidden mt-4 bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg relative" role="alert">
                <strong class="font-bold">Erro:</strong>
                <span class="block sm:inline" id="error-message"></span>
            </div>
        </main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, where, serverTimestamp, getDocs, orderBy } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import * as pdfjsLib from 'https://mozilla.github.io/pdf.js/build/pdf.mjs';

        const firebaseConfig = {
          apiKey: "AIzaSyD_awev3z5vRqoIEC52GHJfxl32pzfteE0",
          authDomain: "pdf-extrator.firebaseapp.com",
          projectId: "pdf-extrator",
          storageBucket: "pdf-extrator.appspot.com",
          messagingSenderId: "1083062925751",
          appId: "1:1083062925751:web:384523e9beb7362bbd5032",
          measurementId: "G-29B954MXCN"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        pdfjsLib.GlobalWorkerOptions.workerSrc = `https://mozilla.github.io/pdf.js/build/pdf.worker.mjs`;
        
        const ui = { /* ... Mesmo objeto ui ... */ };

        let allExtractedData = [];
        let sortState = { key: null, direction: 'asc' };
        let currentSelectedFields = [];
        let currentPage = 1;
        const ITEMS_PER_PAGE = 10;
        let unsubscribe = null;
        let userId = localStorage.getItem('userId') || `user_${Math.random().toString(36).substr(2, 9)}`;
        localStorage.setItem('userId', userId);

        ui.pdfFileInput.addEventListener('change', /* ... mesma lógica ... */);

        ui.extractButton.addEventListener('click', async () => {
            const files = Array.from(ui.pdfFileInput.files);
            if (files.length === 0) return showError('Nenhum arquivo selecionado.');
            
            resetState();
            ui.extractButton.disabled = true;
            ui.queueStatusSection.classList.remove('hidden');

            const jobIds = [];
            
            // Adiciona todos os arquivos na fila primeiro
            for (const file of files) {
                try {
                    const text = await extractTextFromPdf(file);
                    const docRef = await addDoc(collection(db, "processing_queue"), { /* ... dados do job ... */ });
                    jobIds.push(docRef.id);
                } catch (err) {
                    showError(`Falha ao enviar o arquivo ${file.name} para a fila.`);
                    console.error(err);
                }
            }

            if (jobIds.length > 0) {
                // Inicia o listener para os resultados
                listenForJobUpdates(jobIds);
                
                // **MUDANÇA PRINCIPAL: Chama a nova API para iniciar o worker**
                try {
                    await fetch('/api/start-processing', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ userId: userId })
                    });
                } catch (err) {
                    showError("Falha ao iniciar o processamento no servidor.");
                    console.error("Error triggering worker:", err);
                }
            }
        });

        function listenForJobUpdates(jobIds) {
             if (unsubscribe) unsubscribe(); 
            // A consulta agora filtra pelos jobs do usuário atual
            const q = query(collection(db, "processing_queue"), where('userId', '==', userId), where('__name__', 'in', jobIds));
            unsubscribe = onSnapshot(q, (snapshot) => { /* ... mesma lógica de antes ... */ });
        }

        async function updateQueueStatus(jobIds) {
            // A consulta agora filtra pelos jobs PENDENTES do usuário atual
            const q = query(collection(db, "processing_queue"), where('userId', '==', userId), where('status', '==', 'pending'), orderBy('createdAt'));
            const pendingSnapshot = await getDocs(q);
            const pendingJobs = pendingSnapshot.docs.map(doc => doc.id);
            const totalInQueue = pendingJobs.length;
            ui.queuePosition.textContent = totalInQueue > 0 ? `Seus ${totalInQueue} arquivo(s) estão sendo processados...` : 'Processando...';
            const completedJobs = allExtractedData.length;
            const progress = (completedJobs / jobIds.length) * 100;
            ui.progressBar.style.width = `${progress}%`;
            if (completedJobs === jobIds.length) {
                ui.queuePosition.textContent = "Todos os arquivos foram processados!";
                if (unsubscribe) unsubscribe();
                ui.downloadExcelButton.classList.remove('hidden');
            }
        }
        
        // As demais funções (resetState, extractTextFromPdf, setupTable, renderTable, etc.)
        // permanecem as mesmas da versão anterior. Omitidas para brevidade.

    </script>
</body>
</html>

